close all
clear all
dbstop if error
ws = 60*2*pi;
D = 1;
H = 4;
H_D = 4;
ch = 0.3;
g = 0.1;
% R = 3;
R = 3;
A = zeros(10,10);
Asys=[-2.02154129907162,-2.02154129907162,3.37221448651499,3.37221448651499,-35.3284363194502,-15.0845952408218,0.0294957097488978;2.97844442004936,-2.02155557995064,3.37223830902464,3.37223830902464,-37.4796739118547,26.7248890390051,0.0294955683251935;-7.44441285846281e-05,-7.44441285846281e-05,0.000124183250158616,0.000124183250158616,-14.2775861756884,-18.0843676610209,-7.37221036020205e-07;-0.000244069227436211,-0.000244069227436211,5.00040714171155,0.000407141711549698,-41.2543331262190,-20.4786187023088,-2.41702028262211e-06;-0.0181189111750564,-0.0181189111750564,368.957755714042,368.957755714042,-3061.48818901534,-1438.14598197400,0.410520568220463;-219.766019846888,-219.766019846888,-248.822326010879,-248.822326010879,2692.41965430183,-1999.05688381319,-2.78814534669016;-0.000755072597575018,-0.000755072597575018,0.00125956702100636,0.00125956702100636,-113.747049616753,199.607813243406,-0.0262680762490353;];

A(1:7,1:7) = Asys;
A(8:10,8:10) = [-D/H/2 ws/2/H 0;
    0 -1/0.3 1/0.3;
    -10/R/2/pi 0 -10];

Csys = 0.01*[0.404308259814324,0.404308259814324,-0.674442897302999,-0.674442897302999,7.06568726389003,3.01691904816436,0.00400386920820763;]/5;
Dsys = 0.404308259814324/5;

Csys_gust = Csys;
%[-0.0119304786065371,-0.0119304786065371,-0.223037418760801,-0.223037418760801,3.27638899828193,4.65509775055520,-1.59296492801531e-06];

A(8,1:7) = Csys*ws/2/H;
% Asys_gust=[1.04213323506800,1.04213323506800,1.30930088851574,1.30930088851574,-22.1808341871678,5.11294527889468,0.00813848579631741;6.04213323506800,1.04213323506800,1.25809473718892,1.25809473718892,-24.7284072161658,46.9126818754184,0.00813848579631741;0,0,-0.621466367150931,-0.621466367150931,-30.9187649209813,-2.56471760921124,0;0,0,3.77031837725083,-1.22968162274917,-62.6030958750795,-5.07474946077559,0;0,0,277.799928130829,277.799928130829,-4639.77414737367,-380.789078019033,-0.0205276545838203;-445.821859069875,-445.821859069875,-92.7959081960517,-92.7959081960517,1830.96853946129,-3488.61706732335,-1.60216207512345;0,0,-0.373730936565068,-0.373730936565068,-26.6173874327611,389.983246306124,-0.0216090659447477];
Asys_gust=Asys;
%[0.0596523930326853,0.0596523930326853,1.11518709380400,1.11518709380400,-16.3819449914097,-23.2754887527760,0.000675567936196088;5.05965239303269,0.0596523930326853,1.06228158735717,1.06228158735717,-19.0026070734729,19.6161333772674,0.000675567936196088;0,0,-0.631454318815195,-0.631454318815195,-31.2858123504253,10.5156150303375,0;0,0,3.74014586412484,-1.25985413587516,-63.8382787909757,20.9747562497034,0;0,0,275.560527890397,275.560527890397,-4731.47643521359,1294.64218953380,0.00441019644240100;-373.329012842231,-373.329012842231,-78.3466324093792,-78.3466324093792,1663.60067761828,-1475.23639468722,-1.03315161388199;0,0,-0.527704657071019,-0.527704657071019,-24.3627820040602,393.069364631714,0.0149420822161742];

A_gust=A;
A_gust(1:7,1:7) = Asys_gust;
Asys_gust(8,1:7) = Csys_gust*ws/2/H;

Dsys_gust = Dsys;

%-0.01193;

B(:,1) = [2.9785
    2.9784
    -0.0001
    -0.0002
    -0.0181
    -219.7660
    -0.0008
    ws/2/H*Dsys
    0
    0];

B(:,2) = [0
    0
    0
    0
    0
    0
    0
    ws/2/H
    0
    0];

B_gust=B;


t  = 0;
Gaussians = randn(10, 10001)/100;
X  = zeros(10,1);
i=1;
j=1;
% P=[232138.555107554,45945.1545375851,2232.70283508489,-86857.7259727833,-24.1223782305890,2073.21244923722,51.3409049426227,1140.63080582811,557423.901305430,136170.461244992;45945.1545375851,646280.757359194,176205.472975105,153478.547226991,1070.58880417116,2381.85166399434,7.00785313048677,107645.767192902,877776.529535275,477132.282641351;2232.70283508489,176205.472975105,4799684.18652413,-1134589.78766955,-15818.8585429602,1318.01248019988,4.36527382564522,15773.1645117400,94865.7786452757,-47709.1814832436;-86857.7259727833,153478.547226991,-1134589.78766955,3105130.49833248,-33447.0355329748,1025.13431485914,0.632822090271339,4755.87049140351,-6175.64187311695,-59511.3066849910;-24.1223782305890,1070.58880417116,-15818.8585429602,-33447.0355329748,6898.20353569416,-2158.93284956557,-0.749691907192885,583.326783273743,3400.38430260102,3102.30936026795;2073.21244923722,2381.85166399434,1318.01248019988,1025.13431485914,-2158.93284956557,2475.00362723899,0.776380016195080,314.565900677745,6080.87328148738,2655.91082293099;51.3409049426227,7.00785313048677,4.36527382564522,0.632822090271339,-0.749691907192885,0.776380016195080,0.999999995849226,-10.7531175854167,158.209980781823,49.0316927814096;1140.63080582811,107645.767192902,15773.1645117400,4755.87049140351,583.326783273743,314.565900677745,-10.7531175854167,22149.2893238457,152306.037664628,123711.284420718;557423.901305430,877776.529535275,94865.7786452757,-6175.64187311695,3400.38430260102,6080.87328148738,158.209980781823,152306.037664628,3083030.05766160,621858.334493761;136170.461244992,477132.282641351,-47709.1814832436,-59511.3066849910,3102.30936026795,2655.91082293099,49.0316927814096,123711.284420718,621858.334493761,1540070.69019817;];
P=[243679.280954048,248461.587063284,-110943.197453255,348928.159046693,-6654.76988908797,3840.17086541807,17.4371844985211,-31803.2536951353,-120680.597343986,10234.8032324676;248461.587063284,539611.490499475,-77270.9625148201,67595.6069721745,-2100.95924904695,7819.23332354822,2.93464649600862,-24180.0590519090,-13772.6128711500,40955.4429169646;-110943.197453255,-77270.9625148201,160749.098165482,-129933.517537732,1670.90832570059,-1712.02795891842,1.78792475006564,6302.77030588693,229207.141777716,-10914.3665907311;348928.159046693,67595.6069721745,-129933.517537732,1337869.39986621,-20228.6652477661,1147.46498890623,0.328579246932397,-29609.9374786109,80684.3554643193,109071.488300074;-6654.76988908797,-2100.95924904695,1670.90832570059,-20228.6652477661,2963.24203573337,686.953623983428,-0.346124702157540,787.485412007919,621.544874882068,-2455.25908790922;3840.17086541807,7819.23332354822,-1712.02795891842,1147.46498890623,686.953623983428,460.585560099921,0.0745766089929916,-372.161121683569,-1021.85075274574,459.625101206869;17.4371844985211,2.93464649600862,1.78792475006564,0.328579246932397,-0.346124702157540,0.0745766089929916,0.999999999725902,-7.08683699983249,190.380767966412,57.7880303132610;-31803.2536951353,-24180.0590519090,6302.77030588693,-29609.9374786109,787.485412007919,-372.161121683569,-7.08683699983249,9301.19622118754,40175.4114105705,29037.4082049391;-120680.597343986,-13772.6128711500,229207.141777716,80684.3554643193,621.544874882068,-1021.85075274574,190.380767966412,40175.4114105705,1133582.38585960,25178.8309094414;10234.8032324676,40955.4429169646,-10914.3665907311,109071.488300074,-2455.25908790922,459.625101206869,57.7880303132610,29037.4082049391,25178.8309094414,515979.057276674];

while i<101
    if Gaussians(:,j)'*P*Gaussians(:,j)<400
        X1{i}  = Gaussians(:,j);
        i=i+1;
    end
    j=j+1;
end
% load('u10.mat');
load('uextsame.mat');
ds2=0.005;
Pd=0.15;
extra = zeros(10,1);
extra(8) = -ws/2/H*Pd*ds2;


% extra(8) = -ws/2/H*Pd;

pred_hor = 1000;
C = eye(10);
D = zeros(10,2);
ss_cont= ss(A, B, C, D); % continuous dynamics
tf_disc = c2d(ss_cont, ds2); % discrete dynamics
ss_cont_gust= ss(A_gust, B_gust, C, D); % continuous dynamics
tf_disc_gust = c2d(ss_cont_gust, ds2); % discrete dynamics
yy{1} = X;
for k = 1:pred_hor+1
    yy{k+1} = tf_disc.A*yy{k}+extra;
    % y{k+1} = tf_disc.A*y{k}+extra;
end
x0=[yy{1:end-1}]';
y{1} = X;
for k = 1:pred_hor+1
    kk = floor(k/10) + 1;    
    y{k+1} = tf_disc.A*y{k}+tf_disc.B*u(:,kk)+extra;
    %     y{k+1} = tf_disc.A*y{k}+extra;
end
xx0=[y{1:end-1}]';
N=100;
for ii=1:N
    x{1} = X1{ii};
    Gaussians = randn(1, 1001);
    G=zeros(10,1001);
    G(7,:)= Gaussians;
    
%     for kk = 1:pred_hor/10  
%         if kk>0 && kk<2
%             u(1,kk)=u(1,kk)-1;
%         end
%     end
        
    for k = 1:pred_hor+1
        kk = floor(k/10) + 1;  
        x{k+1} = tf_disc.A*x{k}+tf_disc.B*u(:,kk)+extra+G(:,k)*sqrt(ds2);
    end
    
    S1{ii}=[x{1:end-1}];
    xx11{ii}=S1{ii}';
    if all(xx11{ii}(1:end,8)/2/pi>=-0.5) && all(xx11{ii}(401:end,8)/2/pi>=-0.4)
        label(ii)=1;
    else
        label(ii)=0;
    end
    robustness1(ii)=min(xx11{ii}(1:end,8)/2/pi+0.5);
    robustness2(ii)=min(xx11{ii}(401:end,8)/2/pi+0.4);
    robustness(ii)=min(robustness1(ii),robustness2(ii))
    sum(label(1:ii))/ii
end

sum(label)
min(robustness(1:N))

tspan=0:ds2:5;

figure;
for i=1:N
    hold on
    plot(tspan, xx11{i}(:,8)/2/pi,'LineWidth',2,'color','b')
end
hold on
plot(tspan, -0.5,'LineWidth',2,'color','r')
hold on
plot(2:ds2:5, -0.4,'LineWidth',2,'color','r')
hold on
plot(2, -1:0.01:0.5,'-','LineWidth',2,'color','r')
% hold on
% plot(tspan, xx0(:,8)/2/pi,'LineWidth',2,'color','b')
% hold on
% plot(tspan, x0(:,8)/2/pi,'LineWidth',2,'color','k')
axis([0 5 -0.6 0.5]);
xlabel('t (s)','fontsize',20)
ylabel('\Deltaf (Hz)','fontsize',20)
set(gca,'linewidth',2,'fontsize',20,'fontname','Times');
set(gcf,'color','white')

figure;
for i=1:N
    hold on
    plot(tspan, xx11{i}(:,7)/2/pi,'LineWidth',2,'color','b')
end
% hold on
% plot(tspan, xx0(:,7)/2/pi,'LineWidth',2,'color','b')
% hold on
% plot(tspan, x0(:,7)/2/pi,'LineWidth',2,'color','k')
% axis([0 5 -inf inf]);
xlabel('t (s)','fontsize',20)
ylabel('\Delta f_r (Hz)','fontsize',20)
set(gca,'linewidth',2,'fontsize',20,'fontname','Times');
set(gcf,'color','white')

